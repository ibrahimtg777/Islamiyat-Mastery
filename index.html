<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CAIE Detailed Notes ‚Äî Unlock to Access</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: #021014;
      color: #e0e7ff;
      overflow-x: hidden;
    }
    #bg {
      position: fixed;
      inset: 0;
      background-image: url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1950&q=80');
      background-size: cover;
      background-position: center;
      filter: saturate(0.9) contrast(0.85);
      z-index: -10;
    }
    #overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(180deg, rgba(6,21,38,0.45) 0%, rgba(2,6,23,0.7) 100%);
      z-index: -9;
    }
    #rainCanvas {
      position: fixed;
      inset: 0;
      z-index: -8;
      pointer-events: none;
      mix-blend-mode: screen;
      opacity: 0.85;
    }
    /* Glass effect */
    .glass {
      background: rgba(255 255 255 / 0.07);
      backdrop-filter: blur(6px) saturate(1.2);
      border: 1px solid rgba(255 255 255 / 0.1);
    }
    .btn-primary {
      background-color: #2563eb;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 600;
      transition: background-color 0.3s;
      user-select: none;
    }
    .btn-primary:hover {
      background-color: #1d4ed8;
    }
    .btn-secondary {
      background-color: transparent;
      border: 1px solid #60a5fa;
      color: #60a5fa;
      padding: 0.4rem 0.8rem;
      border-radius: 0.375rem;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s, color 0.3s;
    }
    .btn-secondary:hover {
      background-color: #2563eb;
      color: white;
    }
    /* Navigation styles */
    #navSubjects, #navChapters {
      max-width: 960px;
      margin: 1rem auto;
      padding: 1rem;
      border-radius: 1rem;
    }
    .subject-card, .chapter-item {
      cursor: pointer;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 0.75rem;
      transition: background-color 0.25s;
      border: 1px solid rgba(255 255 255 / 0.1);
    }
    .subject-card:hover, .chapter-item:hover {
      background-color: rgba(37 99 235 / 0.3);
    }
    .locked {
      opacity: 0.55;
      cursor: not-allowed;
    }
    /* Content */
    #contentArea {
      max-width: 900px;
      margin: 1rem auto 3rem auto;
      padding: 1.5rem 1rem;
      background: rgba(0 0 0 / 0.4);
      border-radius: 1rem;
      overflow-y: auto;
      max-height: 65vh;
      line-height: 1.6;
      user-select: text;
    }
    h1, h2, h3 {
      color: #60a5fa;
      margin-bottom: 0.75rem;
    }
    p {
      margin-bottom: 1rem;
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 4px solid #2563eb;
      color: #a5b4fc;
      font-style: italic;
    }
    code, pre {
      background: rgba(255 255 255 / 0.1);
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-family: monospace;
      overflow-x: auto;
    }
    /* Scrollbar for content area */
    #contentArea::-webkit-scrollbar {
      width: 8px;
    }
    #contentArea::-webkit-scrollbar-thumb {
      background: #2563eb;
      border-radius: 10px;
    }
    /* Buttons container */
    #buttonRow {
      max-width: 900px;
      margin: 0 auto 1rem auto;
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }
    /* Modal */
    #payfastModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 1rem;
    }
    #payfastModal .modal-content {
      background: #0e1726;
      padding: 2rem;
      border-radius: 1rem;
      max-width: 400px;
      width: 100%;
      color: #cbd5e1;
      box-shadow: 0 0 15px 3px #2563ebaa;
    }
    #payfastModal label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 600;
      color: #60a5fa;
    }
    #payfastModal input {
      width: 100%;
      padding: 0.5rem;
      border-radius: 0.375rem;
      border: none;
      margin-bottom: 1rem;
      background: #1e293b;
      color: #e0e7ff;
    }
    #payfastModal button {
      width: 100%;
      padding: 0.6rem;
      border-radius: 0.375rem;
      font-weight: 700;
      cursor: pointer;
      border: none;
      background-color: #2563eb;
      color: white;
      transition: background-color 0.3s;
    }
    #payfastModal button:hover {
      background-color: #1d4ed8;
    }
    #payfastModal .close-btn {
      margin-top: 0.5rem;
      background: transparent;
      color: #60a5fa;
      font-weight: 500;
    }
    #payfastModal .close-btn:hover {
      color: white;
    }
    /* Spinner */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div id="bg" aria-hidden="true"></div>
  <div id="overlay" aria-hidden="true"></div>
  <canvas id="rainCanvas" aria-hidden="true"></canvas>

  <header class="max-w-5xl mx-auto pt-8 px-4">
    <h1 class="text-4xl font-extrabold text-center text-sky-400 mb-6 select-none">üå≤ CAIE Comprehensive Notes Portal</h1>
    <p class="text-center text-slate-300 max-w-xl mx-auto mb-10 select-none">Unlock detailed, syllabus-aligned notes for all CAIE subjects. Browse subjects, select chapters, and read or download after unlocking.</p>
  </header>

  <main class="max-w-5xl mx-auto px-4">
    <!-- Navigation: Subjects -->
    <section id="navSubjects" class="glass p-6 mb-8">
      <h2 class="text-2xl font-semibold mb-4">Subjects</h2>
      <div id="subjectsList"></div>
    </section>

    <!-- Navigation: Chapters -->
    <section id="navChapters" class="glass p-6 mb-8 hidden">
      <button id="backToSubjects" class="btn-secondary mb-4">‚Üê Back to Subjects</button>
      <h2 class="text-2xl font-semibold mb-4" id="chaptersTitle">Chapters</h2>
      <div id="chaptersList"></div>
    </section>

    <!-- Notes Content -->
    <section id="notesSection" class="hidden">
      <button id="backToChapters" class="btn-secondary mb-4">‚Üê Back to Chapters</button>
      <h2 class="text-3xl font-bold mb-6" id="noteTitle"></h2>
      <div id="contentArea" tabindex="0" role="region" aria-live="polite" aria-label="Notes content"></div>
    </section>

    <!-- Buttons for download & unlock -->
    <div id="buttonRow" class="hidden">
      <button id="btnUnlock" class="btn-primary">Unlock Subject - $6.99</button>
      <button id="btnDownload" class="btn-secondary hidden">Download Notes</button>
    </div>
  </main>

  <!-- PayFast Demo Modal -->
  <div id="payfastModal" role="dialog" aria-modal="true" aria-labelledby="payfastTitle">
    <div class="modal-content">
      <h2 id="payfastTitle" class="text-2xl font-bold mb-4 text-sky-400">Demo PayFast Payment</h2>
      <form id="payfastForm" novalidate>
        <label for="pfName">Full Name</label>
        <input type="text" id="pfName" name="pfName" placeholder="Your full name" autocomplete="name" required />
        <label for="pfEmail">Email Address</label>
        <input type="email" id="pfEmail" name="pfEmail" placeholder="you@example.com" autocomplete="email" required />
        <label for="pfCard">Card Number (13-19 digits)</label>
        <input type="text" id="pfCard" name="pfCard" placeholder="1234 5678 9012 3456" pattern="\\d{13,19}" title="Enter 13 to 19 digits" autocomplete="cc-number" required />
        <div style="display:flex; gap: 1rem;">
          <div style="flex:1;">
            <label for="pfExpiry">Expiry (MM/YY)</label>
            <input type="text" id="pfExpiry" name="pfExpiry" placeholder="MM/YY" pattern="(0[1-9]|1[0-2])\\/\\d{2}" title="Format MM/YY" autocomplete="cc-exp" required />
          </div>
          <div style="width:80px;">
            <label for="pfCVV">CVV</label>
            <input type="text" id="pfCVV" name="pfCVV" placeholder="123" pattern="\\d{3,4}" title="3 or 4 digits" autocomplete="cc-csc" required />
          </div>
        </div>
        <button type="submit" id="pfPay" class="btn-primary mt-4 flex items-center justify-center">
          Pay $6.99 <span id="pfSpinner" class="spinner hidden"></span>
        </button>
      </form>
      <button id="pfCancel" class="close-btn mt-3 w-full">Cancel</button>
    </div>
  </div>

  <script>
  // Rain animation setup
  (function() {
    const canvas = document.getElementById('rainCanvas');
    const ctx = canvas.getContext('2d');
    let w = canvas.width = window.innerWidth;
    let h = canvas.height = window.innerHeight;
    const drops = [];
    const DROP_COUNT = Math.floor((w * h) / 15000);

    function rand(min, max) { return Math.random() * (max - min) + min; }
    function reset() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
      drops.length = 0;
      for (let i = 0; i < DROP_COUNT; i++) {
        drops.push({
          x: Math.random() * w,
          y: Math.random() * h,
          length: rand(10, 24),
          velocityY: rand(300, 800) / 1000,
          thickness: rand(0.8, 1.8),
          sway: rand(-0.6, 0.6),
          opacity: rand(0.1, 0.25)
        });
      }
    }
    let last = performance.now();
    function draw(now) {
      const dt = (now - last) / 1000;
      last = now;
      ctx.clearRect(0, 0, w, h);
      ctx.lineCap = 'round';
      for (let d of drops) {
        d.y += d.velocityY * 1500 * dt;
        d.x += Math.sin((d.y + now * 0.001) * 0.003) * (d.sway * 2);
        if (d.y > h + 30) {
          d.y = -20;
          d.x = Math.random() * w;
        }
        ctx.beginPath();
        ctx.strokeStyle = `rgba(200,230,255,${d.opacity})`;
        ctx.lineWidth = d.thickness;
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x + d.sway * 8, d.y + d.length);
        ctx.stroke();
      }
      requestAnimationFrame(draw);
    }
    window.addEventListener('resize', reset);
    reset();
    requestAnimationFrame(draw);
  })();

  // Data structure: Subjects -> Chapters -> Detailed Notes
  const DATA = {
    islamiyat: {
      title: "Islamiyat",
      price: 6.99,
      chapters: [
        {
          title: "Chapter 1: The Life of the Prophet Muhammad (PBUH)",
          content: `
### Early Life
The Prophet Muhammad (peace be upon him) was born in Makkah in 570 CE, known as the Year of the Elephant. Orphaned early, he was raised by his grandfather Abdul Muttalib and later by his uncle Abu Talib. He earned the titles Al-Amin (the trustworthy) and As-Sadiq (the truthful) for his honesty.

### First Revelation
At age 40, during meditation in the Cave of Hira, the Angel Jibril appeared and revealed the first verses of the Qur'an (Surah Al-‚ÄòAlaq 96:1-5):

> *"Read in the name of your Lord who created ‚Äî Created man from a clinging substance. Read, and your Lord is the most Generous ‚Äî Who taught by the pen ‚Äî Taught man that which he knew not."*

### Opposition and Migration
The message challenged the Quraysh's polytheistic beliefs and social order, causing persecution. After 13 years, the Prophet migrated (Hijrah) to Yathrib (later Madinah) in 622 CE, marking the Islamic calendar's start.

### Life in Madinah
The Prophet established the Constitution of Madinah, uniting diverse tribes. Key battles include Badr, Uhud, and Khandaq. Treaty of Hudaybiyyah exemplified diplomacy.

### Death and Legacy
He passed away in 632 CE in Madinah, leaving a profound legacy that shaped Islamic civilization.

### Important Hadith
> *‚ÄúThe best among you are those who have the best manners and character.‚Äù* ‚Äî Sahih Bukhari
`
        },
        {
          title: "Chapter 2: The Qur'an and Its Importance",
          content: `
### Revelation Process
The Qur'an was revealed over 23 years in Arabic through Angel Jibril to the Prophet Muhammad (PBUH). It is divided into 114 chapters (Surahs).

### Structure and Themes
The Qur'an covers Tawheed (Oneness of God), Prophethood, the Hereafter, laws, and ethics.

### Preservation
The Qur'an was memorized and written down by companions. It remains unchanged and is recited worldwide.

### Role in Life
It guides daily worship, ethics, and social conduct.

### Key Verses
> *"Indeed, this Qur'an guides to that which is most suitable..."* (Surah Al-Isra 17:9)
`
        },
        {
          title: "Chapter 3: The Five Pillars of Islam",
          content: `
1. **Shahadah (Faith):** Declaration that there is no god but Allah and Muhammad is His messenger.

2. **Salah (Prayer):** Five daily prayers facing the Kaaba.

3. **Zakat (Charity):** Obligatory almsgiving to support the needy.

4. **Sawm (Fasting):** Fasting during Ramadan from dawn to sunset.

5. **Hajj (Pilgrimage):** Pilgrimage to Makkah at least once if able.

Each pillar represents a foundation of Muslim faith and practice.
`
        },
        {
          title: "Chapter 4: The Six Articles of Faith (Iman)",
          content: `
1. **Belief in Allah:** The One true God, creator and sustainer.

2. **Belief in Angels:** Created from light, they serve Allah.

3. **Belief in Divine Books:** Qur'an, Torah, Psalms, Gospel as revealed scriptures.

4. **Belief in Prophets:** Messengers including Adam, Noah, Moses, Jesus, and Muhammad (PBUH).

5. **Belief in the Day of Judgment:** Accountability after death.

6. **Belief in Qadar (Divine Decree):** Allah‚Äôs predestination.

Faith in these underpins the Muslim worldview.
`
        },
        {
          title: "Chapter 5: Life After Death and the Day of Judgment",
          content: `
### Barzakh (The Intermediate Stage)
After death, souls enter Barzakh, a barrier until resurrection.

### Resurrection
On the Last Day, all humans will be resurrected for judgment.

### Accountability
Deeds will be weighed; good rewarded with Jannah (Paradise), evil punished in Jahannam (Hellfire).

### Descriptions of Paradise and Hell
Paradise is described as gardens beneath which rivers flow, eternal bliss. Hellfire is severe torment for disbelievers and sinners.

### Quranic Verse
> *‚ÄúAnd We will set up the scales of justice for the Day of Resurrection...‚Äù* (Surah Al-Anbiya 21:47)
`
        },
        {
          title: "Chapter 6: Prophethood and the Role of Prophets",
          content: `
Prophets are chosen by Allah to guide humanity. They bring divine messages and examples for righteous living.

### Examples:
- **Prophet Adam:** First human and prophet.
- **Prophet Nuh (Noah):** Warned his people of the flood.
- **Prophet Musa (Moses):** Led Israelites out of Egypt.
- **Prophet Isa (Jesus):** Born miraculously, brought the Injil.
- **Prophet Muhammad (PBUH):** Seal of the Prophets.

### Characteristics of Prophets
Truthful, patient, humble, trustworthy.

### Hadith
> *‚ÄúThere is no prophet between me and him, that is, Jesus.‚Äù* ‚Äî Sahih Bukhari
`
        },
        {
          title: "Chapter 7: Islamic Ethics and Morality",
          content: `
### Core Ethical Principles
- Justice ('Adl)
- Mercy and Compassion
- Truthfulness and Honesty
- Respect and Kindness
- Patience and Perseverance

### Social Justice
Emphasizes caring for orphans, the poor, and the oppressed.

### Quranic Guidance
> *‚ÄúIndeed, Allah commands you to render trusts to whom they are due and when you judge between people to judge with justice.‚Äù* (Surah An-Nisa 4:58)

### Hadith
> *‚ÄúThe strong person is not the good wrestler, but the strong person is the one who controls himself when he is angry.‚Äù* ‚Äî Sahih Bukhari
`
        },
        {
          title: "Chapter 8: Islamic History and Civilization",
          content: `
### Early Caliphates
- Abu Bakr (R.A): Unified Arabia, fought apostasy wars.
- Umar (R.A): Expanded Islamic state, established justice system.
- Uthman (R.A): Commissioned the official Qur'an compilation.
- Ali (R.A): Known for wisdom and courage.

### Golden Age
Advancements in science, medicine, philosophy, and arts during Abbasid period.

### Contributions
Muslim scholars preserved and expanded classical knowledge, influencing Renaissance Europe.

### Legacy
Islamic civilization spread values of knowledge, tolerance, and culture globally.
`
        }
      ]
    },
    mathematics: {
      title: "Mathematics",
      price: 6.99,
      chapters: [
        {
          title: "Chapter 1: Algebra",
          content: `
### Introduction to Algebra
Algebra deals with symbols and the rules for manipulating those symbols. It allows us to solve equations and understand patterns.

### Key Concepts:
- Variables: Letters that represent numbers.
- Expressions: Combinations of numbers and variables.
- Equations: Statements that two expressions are equal.

### Example:
Solve for x: 2x + 5 = 15  
Subtract 5 from both sides: 2x = 10  
Divide both sides by 2: x = 5
`
        },
        {
          title: "Chapter 2: Geometry",
          content: `
### Basic Geometry
Study of shapes, sizes, relative positions, and properties of space.

### Important Terms:
- Points, Lines, Angles
- Triangles: Types (equilateral, isosceles, scalene)
- Circles: Radius, diameter, circumference

### Example:
Area of a triangle = 1/2 √ó base √ó height
`
        },
        {
          title: "Chapter 3: Trigonometry",
          content: `
### Basics of Trigonometry
Deals with relationships between the sides and angles of triangles.

### Important Ratios:
- Sine (sin)
- Cosine (cos)
- Tangent (tan)

### Example:
sin(Œ∏) = opposite / hypotenuse
`
        },
        {
          title: "Chapter 4: Calculus",
          content: `
### Introduction to Calculus
Focuses on rates of change (differentiation) and accumulation of quantities (integration).

### Derivatives
Measures the rate at which a function changes.

### Integrals
Measures the area under a curve.

### Example:
If f(x) = x¬≤, then f'(x) = 2x
`
        }
      ]
    },
    physics: {
      title: "Physics",
      price: 6.99,
      chapters: [
        {
          title: "Chapter 1: Mechanics",
          content: `
### Motion and Forces
Study of how objects move and interact.

### Newton‚Äôs Laws
1. An object remains at rest or in uniform motion unless acted upon.
2. F = ma (Force equals mass times acceleration)
3. For every action, there is an equal and opposite reaction.

### Example:
Calculate force: A 5 kg object accelerates at 2 m/s¬≤  
F = 5 √ó 2 = 10 N
`
        },
        {
          title: "Chapter 2: Waves and Optics",
          content: `
### Waves
Transfer of energy through oscillations.

### Types:
- Transverse waves
- Longitudinal waves

### Optics
Study of light behavior, reflection, refraction.

### Example:
Snell‚Äôs Law: n‚ÇÅ sin Œ∏‚ÇÅ = n‚ÇÇ sin Œ∏‚ÇÇ
`
        },
        {
          title: "Chapter 3: Electricity and Magnetism",
          content: `
### Electricity
Study of electric charges and currents.

### Magnetism
Study of magnetic fields and forces.

### Important Formulas:
Ohm‚Äôs Law: V = IR  
Magnetic force: F = qvB sin Œ∏
`
        }
      ]
    },
    chemistry: {
      title: "Chemistry",
      price: 6.99,
      chapters: [
        {
          title: "Chapter 1: Atomic Structure",
          content: `
### Atoms
Basic unit of matter, composed of protons, neutrons, and electrons.

### Atomic Number and Mass
Atomic number = number of protons  
Mass number = protons + neutrons

### Example:
Carbon has 6 protons and typically 6 neutrons.
`
        },
        {
          title: "Chapter 2: Chemical Bonding",
          content: `
### Types of Bonds
- Ionic: Transfer of electrons
- Covalent: Sharing of electrons

### Properties
Bond strength, polarity, and molecular geometry.

### Example:
Water (H‚ÇÇO) has polar covalent bonds.
`
        },
        {
          title: "Chapter 3: Stoichiometry",
          content: `
### Calculations in Chemistry
Relates quantities of reactants and products.

### Example:
Balanced equation: 2H‚ÇÇ + O‚ÇÇ ‚Üí 2H‚ÇÇO  
Calculate mass of water formed from given hydrogen.
`
        }
      ]
    },
    english: {
      title: "English",
      price: 6.99,
      chapters: [
        {
          title: "Chapter 1: Grammar Essentials",
          content: `
### Parts of Speech
- Nouns, pronouns, verbs, adjectives, adverbs

### Sentence Structure
- Subject + predicate
- Types of sentences: declarative, interrogative, imperative, exclamatory

### Example:
She (subject) runs (verb) fast (adverb).
`
        },
        {
          title: "Chapter 2: Comprehension and Analysis",
          content: `
### Reading Comprehension
Understanding main ideas, themes, and vocabulary.

### Literary Devices
- Metaphor, simile, personification, irony

### Example:
‚ÄúThe wind whispered through the trees‚Äù is personification.
`
        },
        {
          title: "Chapter 3: Essay Writing",
          content: `
### Structure of Essays
- Introduction
- Body paragraphs
- Conclusion

### Tips
Use clear topic sentences, supporting evidence, and cohesive transitions.

### Example:
An essay on ‚ÄúThe Importance of Education‚Äù
`
        }
      ]
    }
  };

  // State management for unlocked subjects
  const unlockedSubjects = new Set(JSON.parse(localStorage.getItem('unlockedSubjects') || '[]'));
  let currentSubjectKey = null;
  let currentChapterIndex = null;

  // Elements refs
  const subjectsList = document.getElementById('subjectsList');
  const navChapters = document.getElementById('navChapters');
  const chaptersList = document.getElementById('chaptersList');
  const chaptersTitle = document.getElementById('chaptersTitle');
  const navSubjects = document.getElementById('navSubjects');
  const notesSection = document.getElementById('notesSection');
  const noteTitle = document.getElementById('noteTitle');
  const contentArea = document.getElementById('contentArea');
  const backToSubjectsBtn = document.getElementById('backToSubjects');
  const backToChaptersBtn = document.getElementById('backToChapters');
  const buttonRow = document.getElementById('buttonRow');
  const btnUnlock = document.getElementById('btnUnlock');
  const btnDownload = document.getElementById('btnDownload');

  // PayFast modal elements
  const payfastModal = document.getElementById('payfastModal');
  const payfastForm = document.getElementById('payfastForm');
  const pfPay = document.getElementById('pfPay');
  const pfSpinner = document.getElementById('pfSpinner');
  const pfCancel = document.getElementById('pfCancel');

  // Utility: sanitize text to HTML (simple)
  function markdownToHTML(md) {
    let html = md
      .replace(/^### (.*$)/gim, '<h3>$1</h3>')
      .replace(/^## (.*$)/gim, '<h2>$1</h2>')
      .replace(/^# (.*$)/gim, '<h1>$1</h1>')
      .replace(/^\> (.*$)/gim, '<blockquote>$1</blockquote>')
      .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/gim, '<em>$1</em>')
      .replace(/\n$/gim, '<br />')
      ;
    return html;
  }

  // Render subjects
  function renderSubjects() {
    navSubjects.classList.remove('hidden');
    navChapters.classList.add('hidden');
    notesSection.classList.add('hidden');
    buttonRow.classList.add('hidden');
    subjectsList.innerHTML = '';
    for (const key in DATA) {
      const subj = DATA[key];
      const card = document.createElement('div');
      card.className = 'subject-card flex justify-between items-center';
      card.setAttribute('role', 'button');
      card.setAttribute('tabindex', 0);
      card.setAttribute('aria-pressed', 'false');
      card.dataset.key = key;

      const titleDiv = document.createElement('div');
      titleDiv.innerHTML = `<h3 class="text-xl font-semibold">${subj.title}</h3>`;

      const priceOrStatus = document.createElement('div');
      priceOrStatus.className = 'text-sky-400 font-semibold select-none';

      if (unlockedSubjects.has(key)) {
        priceOrStatus.textContent = 'Unlocked';
        card.classList.remove('locked');
      } else {
        priceOrStatus.textContent = `$${subj.price.toFixed(2)}`;
        card.classList.add('locked');
      }

      card.appendChild(titleDiv);
      card.appendChild(priceOrStatus);

      card.addEventListener('click', () => {
        if (!unlockedSubjects.has(key)) {
          // Show unlock modal for subject
          currentSubjectKey = key;
          openPayfastModal(subj.price);
          return;
        }
        showChapters(key);
      });
      card.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          card.click();
        }
      });
      subjectsList.appendChild(card);
    }
  }

  // Show chapters for a subject
  function showChapters(subjectKey) {
    currentSubjectKey = subjectKey;
    const subj = DATA[subjectKey];
    navSubjects.classList.add('hidden');
    navChapters.classList.remove('hidden');
    notesSection.classList.add('hidden');
    buttonRow.classList.add('hidden');
    chaptersTitle.textContent = `${subj.title} - Chapters`;
    chaptersList.innerHTML = '';
    subj.chapters.forEach((chap, i) => {
      const item = document.createElement('div');
      item.className = 'chapter-item';
      item.setAttribute('role', 'button');
      item.setAttribute('tabindex', 0);
      item.dataset.index = i;
      item.textContent = chap.title;
      item.addEventListener('click', () => {
        showNote(subjectKey, i);
      });
      item.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          item.click();
        }
      });
      chaptersList.appendChild(item);
    });
  }

  // Show note content
  function showNote(subjectKey, chapterIndex) {
    currentChapterIndex = chapterIndex;
    const subj = DATA[subjectKey];
    const chapter = subj.chapters[chapterIndex];
    navSubjects.classList.add('hidden');
    navChapters.classList.add('hidden');
    notesSection.classList.remove('hidden');
    buttonRow.classList.remove('hidden');

    noteTitle.textContent = chapter.title;
    contentArea.innerHTML = markdownToHTML(chapter.content);
    btnDownload.classList.add('hidden');
    btnUnlock.classList.add('hidden');
  }

  // Back buttons
  backToSubjectsBtn.addEventListener('click', () => {
    renderSubjects();
  });
  backToChaptersBtn.addEventListener('click', () => {
    showChapters(currentSubjectKey);
  });

  // Unlock button logic
  btnUnlock.addEventListener('click', () => {
    if (currentSubjectKey) {
      openPayfastModal(DATA[currentSubjectKey].price);
    }
  });

  // Download notes (simple text download)
  btnDownload.addEventListener('click', () => {
    if (!currentSubjectKey || currentChapterIndex === null) return;
    const subj = DATA[currentSubjectKey];
    const chapter = subj.chapters[currentChapterIndex];
    const filename = `${subj.title} - ${chapter.title}.txt`;
    const blob = new Blob([chapter.content], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // PayFast modal open
  function openPayfastModal(amount) {
    payfastModal.style.display = 'flex';
    pfPay.disabled = false;
    pfSpinner.classList.add('hidden');
    payfastForm.reset();
    pfPay.textContent = `Pay $${amount.toFixed(2)}`;
    pfPay.appendChild(pfSpinner);
    pfPay.setAttribute('aria-busy', 'false');
  }

  // PayFast modal close
  function closePayfastModal() {
    payfastModal.style.display = 'none';
  }

  pfCancel.addEventListener('click', e => {
    e.preventDefault();
    closePayfastModal();
  });

  // Payment form submission (demo validation)
  payfastForm.addEventListener('submit', e => {
    e.preventDefault();
    // Basic validation
    const card = payfastForm.pfCard.value.replace(/\s/g,'');
    if (!/^\d{13,19}$/.test(card)) {
      alert("Card number must be 13 to 19 digits.");
      return;
    }
    if (!payfastForm.checkValidity()) {
      alert("Please fill out all fields correctly.");
      return;
    }

    pfPay.disabled = true;
    pfSpinner.classList.remove('hidden');
    pfPay.setAttribute('aria-busy', 'true');

    // Simulate payment delay
    setTimeout(() => {
      // On success:
      unlockedSubjects.add(currentSubjectKey);
      localStorage.setItem('unlockedSubjects', JSON.stringify([...unlockedSubjects]));
      alert("Payment successful! Subject unlocked.");
      closePayfastModal();
      renderSubjects();
    }, 2000);
  });

  // On page load:
  renderSubjects();

  </script>
</body>
</html>
