<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAIE Notes â€” Forest Rain UI with Demo PayFast</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body { height: 100%; margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #bg {
      position: fixed;
      inset: 0;
      background-image: url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1950&q=80');
      background-size: cover;
      background-position: center;
      filter: saturate(0.9) contrast(0.9);
      z-index: -3;
    }
    #overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(180deg, rgba(6,21,38,0.45) 0%, rgba(2,6,23,0.6) 100%);
      z-index: -2;
    }
    #rainCanvas {
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      mix-blend-mode: screen;
      opacity: 0.85;
    }
    .glass {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(6px) saturate(1.1);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .card-hover:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(2,6,23,0.55); }
    .note-content { white-space: pre-wrap; line-height: 1.6; color: #e6eef8; }
    .grid-cols-responsive { grid-template-columns: repeat(1, minmax(0,1fr)); }
    @media(min-width: 640px) { .grid-cols-responsive { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media(min-width: 1024px) { .grid-cols-responsive { grid-template-columns: repeat(3, minmax(0,1fr)); } }
    /* Spinner */
    .spinner {
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-left: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Fix buttons container to not leave extra space */
    .btn-group {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: nowrap;
      flex-shrink: 0;
    }
    .btn-group button {
      min-width: 75px;
    }
  </style>
</head>
<body class="min-h-screen text-slate-100">

  <div id="bg" aria-hidden="true"></div>
  <div id="overlay" aria-hidden="true"></div>
  <canvas id="rainCanvas" aria-hidden="true"></canvas>

  <div class="relative z-10 min-h-screen flex flex-col">
    <header class="py-6">
      <div class="max-w-6xl mx-auto px-4 flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-extrabold tracking-tight drop-shadow-md">ðŸŒ² CAIE Notes â€” Forest Edition</h1>
          <p class="text-slate-300 mt-1">Original, syllabus-aligned study notes. Unlock to read. (Payments simulated â€” stored locally.)</p>
        </div>
        <div class="flex items-center gap-3">
          <button id="unlockAllBtn" class="px-3 py-2 rounded-md glass text-sky-200 hover:bg-white/5 transition">Unlock All</button>
          <button id="exportAllBtn" class="px-3 py-2 rounded-md glass text-sky-200 hover:bg-white/5 transition">Download All</button>
        </div>
      </div>
    </header>

    <main class="flex-1">
      <div class="max-w-6xl mx-auto px-4 pb-12">
        <section class="grid gap-6 grid-cols-responsive">
          <div class="glass rounded-2xl p-6 flex flex-col gap-4">
            <h2 class="text-xl font-semibold">How it works</h2>
            <p class="text-slate-300">Click a subject card to preview. Click <strong>Unlock</strong> to simulate purchase â€” a PayFast-style demo payment will appear. Unlocks persist locally. Use <em>Download</em> to save notes as .txt files.</p>
            <div class="flex gap-3">
              <button id="demoLockBtn" class="px-4 py-2 bg-indigo-600 rounded-md shadow hover:brightness-105">Demo: Lock All (Shift+L)</button>
              <button id="demoInfoBtn" class="px-4 py-2 border rounded-md">About Notes</button>
            </div>
          </div>

          <div class="glass rounded-2xl p-6 col-span-1 lg:col-span-2">
            <h3 class="text-lg font-semibold mb-4">Subjects</h3>
            <div id="subjectsGrid" class="grid gap-4 grid-cols-responsive"></div>
          </div>
        </section>

        <div class="mt-8 text-slate-300 text-sm text-center">Tip: Press <strong>Shift + L</strong> to lock (clear) unlocked subjects. Â© <span id="year"></span></div>
      </div>
    </main>
  </div>

  <!-- Notes modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-20">
    <div class="absolute inset-0 bg-black/50" id="modalBackdrop"></div>
    <div class="relative max-w-4xl w-full mx-4">
      <div class="bg-gradient-to-r from-slate-900/80 to-slate-800/70 rounded-2xl p-6 glass shadow-2xl overflow-hidden">
        <div class="flex items-start justify-between gap-4">
          <h2 id="modalTitle" class="text-2xl font-bold text-sky-100"></h2>
          <div class="btn-group">
            <button id="modalDownload" class="px-3 py-2 border rounded text-sky-100">Download</button>
            <button id="modalPrint" class="px-3 py-2 border rounded text-sky-100">Print</button>
            <button id="modalClose" class="px-3 py-2 bg-red-600 rounded text-white">Close</button>
          </div>
        </div>
        <div class="mt-4 max-h-[60vh] overflow-auto note-content" id="modalContent" style="padding-right:12px;"></div>
      </div>
    </div>
  </div>

  <!-- Demo PayFast modal -->
  <div id="payfastModal" class="fixed inset-0 hidden items-center justify-center z-30">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="relative max-w-md w-full mx-4 bg-gradient-to-r from-sky-900 to-indigo-900 rounded-3xl p-8 glass shadow-2xl text-slate-100">
      <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/PayFast_Logo.svg/1280px-PayFast_Logo.svg.png" alt="PayFast" class="w-20">
        Demo Payment
      </h2>
      <form id="payfastForm" class="flex flex-col gap-4" novalidate>
        <input type="text" id="pfName" placeholder="Full Name" class="p-3 rounded bg-slate-800 placeholder-slate-400" required autocomplete="name" />
        <input type="email" id="pfEmail" placeholder="Email Address" class="p-3 rounded bg-slate-800 placeholder-slate-400" required autocomplete="email" />
        <input
          type="tel"
          id="pfCard"
          placeholder="Card Number (13-19 digits)"
          class="p-3 rounded bg-slate-800 placeholder-slate-400"
          required
          autocomplete="cc-number"
        />
        <div class="flex gap-4">
          <input type="text" id="pfExpiry" placeholder="MM/YY" class="p-3 rounded bg-slate-800 placeholder-slate-400 flex-1" required pattern="(0[1-9]|1[0-2])\/\d{2}" title="Format MM/YY" autocomplete="cc-exp" />
          <input type="text" id="pfCVV" placeholder="CVV" class="p-3 rounded bg-slate-800 placeholder-slate-400 w-24" required pattern="\d{3,4}" title="3 or 4 digits" autocomplete="cc-csc" />
        </div>
        <div class="flex items-center justify-between mt-6">
          <button type="button" id="pfCancel" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 transition">Cancel</button>
          <button type="submit" id="pfPay" class="px-4 py-2 bg-green-600 rounded hover:bg-green-700 flex items-center justify-center transition">
            Pay <span id="pfSpinner" class="spinner hidden"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
  // Rain animation (canvas)
  (function() {
    const canvas = document.getElementById('rainCanvas');
    const ctx = canvas.getContext('2d');
    let w = canvas.width = innerWidth;
    let h = canvas.height = innerHeight;
    const drops = [];
    const DROP_COUNT = Math.floor((w * h) / 12000);

    function rand(min, max) { return Math.random() * (max - min) + min; }
    function reset() {
      w = canvas.width = innerWidth;
      h = canvas.height = innerHeight;
      drops.length = 0;
      for (let i = 0; i < DROP_COUNT; i++) {
        drops.push({
          x: Math.random() * w,
          y: Math.random() * h,
          len: rand(10, 24),
          velY: rand(300, 900) / 1000,
          thickness: rand(0.8, 1.8),
          sway: rand(-0.6, 0.6),
          opacity: rand(0.12, 0.28)
        });
      }
    }
    let last = performance.now();
    function draw(now) {
      const dt = (now - last) / 1000; last = now;
      ctx.clearRect(0,0,w,h);
      const grad = ctx.createLinearGradient(0,0,0,h);
      grad.addColorStop(0, 'rgba(255,255,255,0)');
      grad.addColorStop(1, 'rgba(0,0,0,0.08)');
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,w,h);
      ctx.lineCap = 'round';
      for (let d of drops) {
        d.y += d.velY * 1200 * dt;
        d.x += Math.sin((d.y + now * 0.001) * 0.002) * (d.sway * 2);
        if (d.y > h + 30) { d.y = -20; d.x = Math.random() * w; }
        ctx.beginPath();
        ctx.strokeStyle = `rgba(200,230,255,${d.opacity})`;
        ctx.lineWidth = d.thickness;
        ctx.moveTo(d.x, d.y);
        ctx.lineTo(d.x + d.sway * 8, d.y + d.len);
        ctx.stroke();
      }
      requestAnimationFrame(draw);
    }
    window.addEventListener('resize', reset);
    reset();
    requestAnimationFrame(draw);
  })();

  // Notes data with updated price $6.99 including Islamiyat
  const NOTES = {
    "mathematics": {
      title: "Mathematics (IGCSE / AS-A Level core concepts)",
      price: 6.99,
      content:
`Mathematics â€” Comprehensive Study Notes

1. Number System & Arithmetic
- Real numbers: integers, rationals, irrationals, decimals and surds. Rationalize denominators; simplify surds using prime factorization.
- Indices (exponents): product, quotient, negative and fractional indices. Use index rules to simplify algebraic expressions.
- Standard form: a Ã— 10^n with 1 â‰¤ a < 10; useful for significant figures.

2. Algebra
- Simplifying expressions, factorisation, completing the square. Solve linear, quadratic and simultaneous equations. Inequalities and functions (domain, range).

3. Coordinate Geometry & Graphs
- Lines (y = mx + c); circles and parabolas; transformations and sketching.

4. Trigonometry
- sin, cos, tan; radian measure; sine & cosine rules for general triangles.

5. Calculus (AS/A-level)
- Limits, differentiation (power, product, chain rules), integration, applications (area, kinematics).

6. Vectors & Geometry
- Vector addition, scalar multiples, dot product, geometric proofs.

7. Probability & Statistics
- Basic probability, permutations/combinations, mean/median/mode, variance & standard deviation.

Exam tips:
- Show full working. Use exact forms (fractions/surds) when asked. Practice past papers.`
    },
    "physics": {
      title: "Physics (IGCSE / AS-A Level core concepts)",
      price: 6.99,
      content:
`Physics â€” Comprehensive Study Notes

1. Mechanics
- Kinematics: displacement, velocity, acceleration. SUVAT equations for constant acceleration.
- Forces & Newton's laws: F = ma, free-body diagrams, equilibrium.

2. Energy & Momentum
- Work, energy, power: KE = 1/2 mv^2, PE = mgh. Conservation of energy and momentum.

3. Waves & Optics
- Wave properties, refraction (Snell's law), lens formula 1/f = 1/u + 1/v.

4. Electricity & Magnetism
- Current, voltage, resistance (Ohm's law). Circuits, EM induction (Faraday's law).

5. Thermal Physics & Modern Physics
- Specific heat, latent heat, photoelectric effect basics.

Practical:
- Use units, show calculations, handle uncertainties.`
    },
    "chemistry": {
      title: "Chemistry (IGCSE / AS-A Level core concepts)",
      price: 6.99,
      content:
`Chemistry â€” Comprehensive Study Notes

1. Atomic Structure & Periodic Table
- Atoms, isotopes, electron configurations and periodic trends.

2. Bonding & Structure
- Ionic, covalent, metallic bonding; intermolecular forces.

3. Quantitative Chemistry
- Mole concept, stoichiometry, titration calculations, concentration (mol/L).

4. Energetics & Equilibrium
- Exothermic/endothermic, Hess' law, Le Chatelier's principle, rate laws.

5. Organic Basics
- Functional groups, isomerism, common reaction types (addition, substitution, oxidation).

Lab tips:
- Familiarise with titration technique and safe handling.`
    },
    "biology": {
      title: "Biology (IGCSE / AS-A Level core concepts)",
      price: 6.99,
      content:
`Biology â€” Comprehensive Study Notes

1. Cell Biology
- Structure of prokaryotic and eukaryotic cells; membrane transport (diffusion, osmosis, active transport).

2. Genetics
- DNA, transcription, translation, meiosis & mitosis, inheritance patterns.

3. Human & Plant Physiology
- Circulatory, respiratory, digestive systems; photosynthesis and plant transport.

4. Ecology & Evolution
- Food webs, energy flow, natural selection, speciation.

Practical:
- Emphasise experimental design, control variables and repeatability.`
    },
    "english": {
      title: "English Language (IGCSE) â€” Reading & Writing Skills",
      price: 6.99,
      content:
`English Language â€” Comprehensive Study Notes

1. Reading
- Identify main idea, tone, purpose, register. Analyse language features (imagery, rhetorical devices).

2. Writing
- Plan structure, paragraph development, tone adaptation. Persuasive techniques and descriptive detail.

3. Grammar
- Sentence structures, punctuation rules, avoiding common errors.

Exam tips:
- Annotate passages, use relevant quotes and explain their effect.`
    },
    "economics": {
      title: "Economics (IGCSE / AS Intro)",
      price: 6.99,
      content:
`Economics â€” Comprehensive Study Notes

1. Basic Economic Problem
- Scarcity, choices, opportunity cost, PPF concept.

2. Demand & Supply
- Determinants, elasticity (PED/PES), movements vs shifts.

3. Macroeconomics
- AD components, inflation, unemployment, fiscal & monetary policy.

4. Market Failure & Trade
- Externalities, public goods, comparative advantage.`
    },
    "history": {
      title: "History (Modern World themes)",
      price: 6.99,
      content:
`History â€” Comprehensive Study Notes

1. Causes of Conflict
- Nationalism, imperialism, alliances, triggers and long-term causes.

2. 20th Century Themes
- World Wars, interwar instability, rise of extremist regimes, Cold War overview.

3. Decolonisation & Development
- Processes of independence, economic and social change.

Exam tips:
- Use timelines, cause-effect chains, primary & secondary sources.`
    },
    "islamiyat": {
      title: "Islamiyat (CAIE IGCSE) â€” Detailed Notes",
      price: 6.99,
      content:
`Islamiyat â€” Detailed Study Notes

Chapter 1: The Life of Prophet Muhammad (PBUH)
- Early life, prophethood, Meccan period, migration (Hijrah), Madinan period.
- Major events: Battles of Badr, Uhud, Khandaq; Treaty of Hudaybiyyah.
- Characteristics and moral teachings of the Prophet.

Chapter 2: The Quran and Hadith
- Revelation process, compilation of Quran.
- Importance and classification of Hadith.
- Major collections and scholars.

Chapter 3: Pillars of Islam
- Shahada: Declaration of faith.
- Salah: Five daily prayers (times, conditions).
- Sawm: Fasting during Ramadan, rules and significance.
- Zakat: Obligatory charity, calculation basics.
- Hajj: Pilgrimage rituals and conditions.

Chapter 4: Beliefs and Faith (Aqidah)
- Articles of faith: belief in Allah, angels, prophets, books, Day of Judgment, Qadar (predestination).
- Tawheed (Oneness of God) explained.
- Importance of Iman and its effects on life.

Chapter 5: Moral and Social Teachings
- Honesty, justice, kindness, respect for parents and elders.
- Rights of neighbors, orphans, and society.
- Prohibition of major sins.

Chapter 6: Islamic History and the Rightly Guided Caliphs
- Abu Bakr, Umar, Uthman, Ali: their contributions and challenges.
- Expansion of Islam and establishment of justice.
- Compilation of Quran during their rule.

Chapter 7: Contemporary Issues in Islam
- Islam and human rights.
- Role of Muslims in modern society.
- Importance of education and knowledge.

Chapter 8: Islamic Practices and Celebrations
- Eid-ul-Fitr, Eid-ul-Adha, significance and practices.
- Friday prayers and mosque importance.
- Daily Islamic etiquettes and supplications.

Exam Tips:
- Use Quranic verses and authentic Hadith.
- Explain concepts clearly with examples.
- Revise the life events chronologically.`
    }
  };

  // State
  let unlockedSubjects = new Set(JSON.parse(localStorage.getItem('unlockedSubjects') || '[]'));
  let currentSubject = null;

  // Elements
  const subjectsGrid = document.getElementById('subjectsGrid');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalContent = document.getElementById('modalContent');
  const modalClose = document.getElementById('modalClose');
  const modalDownload = document.getElementById('modalDownload');
  const modalPrint = document.getElementById('modalPrint');
  const unlockAllBtn = document.getElementById('unlockAllBtn');
  const exportAllBtn = document.getElementById('exportAllBtn');
  const demoLockBtn = document.getElementById('demoLockBtn');
  const demoInfoBtn = document.getElementById('demoInfoBtn');

  // PayFast modal elements
  const payfastModal = document.getElementById('payfastModal');
  const payfastForm = document.getElementById('payfastForm');
  const pfName = document.getElementById('pfName');
  const pfEmail = document.getElementById('pfEmail');
  const pfCard = document.getElementById('pfCard');
  const pfExpiry = document.getElementById('pfExpiry');
  const pfCVV = document.getElementById('pfCVV');
  const pfCancel = document.getElementById('pfCancel');
  const pfPay = document.getElementById('pfPay');
  const pfSpinner = document.getElementById('pfSpinner');

  // Render subjects grid
  function renderSubjects() {
    subjectsGrid.innerHTML = '';
    Object.entries(NOTES).forEach(([key, subj]) => {
      const unlocked = unlockedSubjects.has(key);
      const card = document.createElement('div');
      card.className = `glass p-6 rounded-2xl flex flex-col justify-between cursor-pointer transition-transform card-hover select-none`;
      card.tabIndex = 0;
      card.setAttribute('role', 'button');
      card.setAttribute('aria-pressed', unlocked ? 'true' : 'false');
      card.dataset.subjectKey = key;

      const priceText = unlocked ? 'Unlocked' : `$${subj.price.toFixed(2)}`;

      card.innerHTML = `
        <h3 class="text-xl font-semibold mb-2">${subj.title}</h3>
        <p class="text-slate-400 mb-4">${unlocked ? 'Click to view notes' : 'Premium content'}</p>
        <div class="text-right text-sm font-semibold ${unlocked ? 'text-green-400' : 'text-sky-400'}">${priceText}</div>
      `;

      card.onclick = () => openSubject(key);
      card.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openSubject(key); } };
      subjectsGrid.appendChild(card);
    });
  }

  // Open subject modal: if unlocked show content else show payfast modal
  function openSubject(key) {
    currentSubject = key;
    if (unlockedSubjects.has(key)) {
      showModal(key);
    } else {
      showPayfast(key);
    }
  }

  // Show notes modal
  function showModal(key) {
    const subj = NOTES[key];
    modalTitle.textContent = subj.title;
    modalContent.textContent = subj.content;
    modal.classList.remove('hidden');
    modal.focus();
  }

  // Close notes modal
  modalClose.onclick = () => {
    modal.classList.add('hidden');
  };
  modalClose.onkeydown = e => {
    if(e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      modal.classList.add('hidden');
    }
  };

  // Download current note
  modalDownload.onclick = () => {
    if (!currentSubject) return;
    const subj = NOTES[currentSubject];
    const blob = new Blob([subj.content], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${subj.title.replace(/\s+/g,'_')}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  // Print current note
  modalPrint.onclick = () => {
    if (!currentSubject) return;
    const subj = NOTES[currentSubject];
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write('<pre style="white-space: pre-wrap; font-family: Arial, sans-serif; font-size:14px;">' + subj.content + '</pre>');
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  };

  // Unlock all
  unlockAllBtn.onclick = () => {
    if(confirm('Unlock all subjects for $' + NOTES["mathematics"].price.toFixed(2) + ' each? This simulates payment for all.')) {
      Object.keys(NOTES).forEach(k => unlockedSubjects.add(k));
      saveUnlocks();
      renderSubjects();
      alert('All subjects unlocked! You can now view any notes.');
    }
  };

  // Export all unlocked notes as .zip (simple fallback: download txts one by one)
  exportAllBtn.onclick = () => {
    if(unlockedSubjects.size === 0) {
      alert('No subjects unlocked yet!');
      return;
    }
    // Because no zip lib, download one by one with delay
    const unlockedArray = Array.from(unlockedSubjects);
    let idx = 0;
    alert('Downloading all unlocked notes one by one. Please allow pop-ups.');

    function downloadNext() {
      if(idx >= unlockedArray.length) return;
      const key = unlockedArray[idx++];
      const subj = NOTES[key];
      const blob = new Blob([subj.content], {type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${subj.title.replace(/\s+/g,'_')}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
      setTimeout(downloadNext, 1000);
    }
    downloadNext();
  };

  // Save unlock state
  function saveUnlocks() {
    localStorage.setItem('unlockedSubjects', JSON.stringify(Array.from(unlockedSubjects)));
  }

  // Demo Lock All (clear unlocks)
  demoLockBtn.onclick = () => {
    if(confirm('Lock all notes? This will clear your unlocks locally.')) {
      unlockedSubjects.clear();
      saveUnlocks();
      renderSubjects();
      alert('All subjects locked.');
    }
  };

  // Demo Info
  demoInfoBtn.onclick = () => {
    alert(
`This demo simulates unlocking premium notes with a mock PayFast payment modal.
Payment data is NOT sent anywhere.
Unlocks persist locally in your browser storage.
You can download notes as .txt files.
Enjoy studying!`
    );
  };

  // Keyboard shortcut Shift+L to lock all
  window.addEventListener('keydown', (e) => {
    if(e.shiftKey && e.key.toLowerCase() === 'l') {
      demoLockBtn.click();
    }
  });

  // PAYFAST DEMO LOGIC

  // Open payfast modal for given subject
  function showPayfast(subjectKey) {
    currentSubject = subjectKey;
    payfastModal.classList.remove('hidden');
    payfastForm.reset();
    pfName.focus();
  }

  // Close payfast modal
  pfCancel.onclick = () => {
    payfastModal.classList.add('hidden');
  };

  // Validate PayFast form card number: accepts digits, spaces, dashes; validates length 13-19 digits
  function validateCardNumber(num) {
    const cleaned = num.replace(/\D/g, '');
    return cleaned.length >= 13 && cleaned.length <= 19;
  }

  // Form submit handler
  payfastForm.onsubmit = (e) => {
    e.preventDefault();

    // Simple validations
    if(pfName.value.trim().length < 3) {
      alert('Please enter your full name.');
      pfName.focus();
      return;
    }
    if(!/\S+@\S+\.\S+/.test(pfEmail.value.trim())) {
      alert('Please enter a valid email address.');
      pfEmail.focus();
      return;
    }
    if(!validateCardNumber(pfCard.value.trim())) {
      alert('Card number must contain 13 to 19 digits.');
      pfCard.focus();
      return;
    }
    if(!/^(0[1-9]|1[0-2])\/\d{2}$/.test(pfExpiry.value.trim())) {
      alert('Expiry must be in MM/YY format.');
      pfExpiry.focus();
      return;
    }
    if(!/^\d{3,4}$/.test(pfCVV.value.trim())) {
      alert('CVV must be 3 or 4 digits.');
      pfCVV.focus();
      return;
    }

    // Show spinner and disable inputs
    pfSpinner.classList.remove('hidden');
    pfPay.disabled = true;
    pfCancel.disabled = true;

    // Simulate delay for payment
    setTimeout(() => {
      // Unlock the current subject
      unlockedSubjects.add(currentSubject);
      saveUnlocks();
      renderSubjects();
      payfastModal.classList.add('hidden');
      pfSpinner.classList.add('hidden');
      pfPay.disabled = false;
      pfCancel.disabled = false;
      alert(`Payment successful! "${NOTES[currentSubject].title}" is now unlocked.`);
      showModal(currentSubject);
    }, 1600);
  };

  // Initialization
  document.getElementById('year').textContent = new Date().getFullYear();
  renderSubjects();

  </script>

</body>
</html>
